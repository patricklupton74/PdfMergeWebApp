<html>
            <head>
                <title>click button to download pdf</title>
                <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
                <link rel="stylesheet" href="/css/merge.css">
            </head>
            <body>
                
                <div class="container">
                    <h1>MERGE PDFS</h1>
                    <form id="mergeForm">
                        <input id="fileInput" type="file" name="files" accept=".pdf" multiple required />
                        <ul id="fileList" style="cursor: grab;"></ul>
                        <button type="submit">MERGE</button>
                    </form>
                </div>

                <script>
                const fileInput = document.getElementById("fileInput");
                const fileList = document.getElementById("fileList");
                const mergeForm = document.getElementById("mergeForm");
                let filesArray = [];
                // handle file selection
                fileInput.addEventListener("change", (event) => {
                    filesArray = Array.from(event.target.files);
                    renderList();
                });

                function renderList() {
                    fileList.innerHTML = "";
                    filesArray.forEach((file, index) => {
                        const li = document.createElement("li");
                        li.textContent = file.name;
                        // refernce to actual file object
                        li.fileReference = file; 
                        fileList.appendChild(li);
                    });
                }
                // sortablejs
                new Sortable(fileList, {
                    animation: 150,
                    onEnd: () => {
                        // adjust filesArray based on the new DOM order
                        const newOrder = [];
                        fileList.querySelectorAll("li").forEach(li => {
                            newOrder.push(li.fileReference);
                        });
                        filesArray = newOrder;
                    }
                });

                // handle form submission + post call
                mergeForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                        
                    if (filesArray.length === 0) return;

                    const formData = new FormData();
                    // append files in the specific order of filesArray
                    filesArray.forEach(file => {
                        formData.append("files", file);
                    });

                    // endpoint call
                    try {
                        const response = await fetch("/merge", {
                            method: "POST",
                            body: formData
                        });
                            
                        if (response.ok) {
                            // handle the downloaded merged PDF
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement("a");
                            a.href = url;
                            a.download = "merged.pdf";
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                        } else {
                            alert("merge failed on server.");
                        }
                    } catch (error) {
                        console.error("error:", error);
                    }
                });
                </script>
                    
            </body>
            </html>
        
     </body>
</html>